<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <title>Resume Analyzer</title>
   <script src="https://cdn.tailwindcss.com"></script>
   <link rel="preconnect" href="https://fonts.googleapis.com">
   <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
   <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
       body { font-family: 'Inter', sans-serif; background-color: #f7f9fc; }
       @keyframes spin { to { transform: rotate(360deg); } }
       .animate-spin-fast { animation: spin 0.7s linear infinite; }
       /* File upload area */
       .file-upload-area {
           border: 2px dashed #d1d5db;
           transition: all 0.3s ease;
       }
       .file-upload-area.dragover {
           border-color: #3b82f6;
           background-color: #eff6ff;
       }
       
       /* Upload state management */
       .upload-state {
           transition: all 0.3s ease;
       }
       
       .upload-state.hidden {
           display: none;
       }
       /* Results modal */
       .results-modal {
           position: fixed;
           top: 0;
           left: 0;
           width: 100%;
           height: 100%;
           background-color: rgba(0, 0, 0, 0.5);
           display: flex;
           justify-content: center;
           align-items: center;
           z-index: 10000;
           opacity: 0;
           visibility: hidden;
           transition: all 0.3s ease;
       }
       .results-modal.show {
           opacity: 1;
           visibility: visible;
       }
       .results-content {
           background: white;
           border-radius: 1rem;
           padding: 2rem;
           max-width: 90vw;
           max-height: 90vh;
           overflow-y: auto;
           box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
           transform: scale(0.9);
           transition: transform 0.3s ease;
       }
       .results-modal.show .results-content {
           transform: scale(1);
       }
       .close-button {
           position: absolute;
           top: 1rem;
           right: 1rem;
           background: #f3f4f6;
            border: none;
           border-radius: 50%;
           width: 2.5rem;
           height: 2.5rem;
           display: flex;
           align-items: center;
           justify-content: center;
            cursor: pointer;
           transition: background-color 0.2s;
       }
       .close-button:hover {
           background: #e5e7eb;
       }
       
       /* Loading overlay */
       .loading-overlay {
           position: fixed;
           top: 0;
           left: 0;
           width: 100%;
           height: 100%;
           background: rgba(0, 0, 0, 0.7);
            display: none;
           justify-content: center;
           align-items: center;
           z-index: 9999;
       }
       
       .loading-overlay.show {
           display: flex;
       }
       
       .hourglass {
           width: 50px;
           height: 50px;
           border: 3px solid #ffffff;
           border-top: 3px solid transparent;
           border-radius: 50%;
           animation: spin 1s linear infinite;
        }
    </style>
</head>
<body class="min-h-screen bg-gray-50 flex flex-col">

   <div class="flex-1 flex items-center justify-center p-4">
       <div class="max-w-4xl w-full mx-auto p-6 lg:p-12 bg-white rounded-xl shadow-lg">

       <!-- Hero Section -->
       <section class="text-center mb-12">
           <h1 class="text-4xl lg:text-6xl font-extrabold text-gray-900 mb-4">
               No Subscriptions. No Commitments. <span class="text-blue-600">Just Results.</span>
           </h1>
           <div class="max-w-4xl mx-auto">
               <p class="text-lg lg:text-xl text-gray-700 leading-relaxed mb-8">
                   Skip Subscription traps. Our specialized AI gets your resume past filters and into interviews. Pay only for what you need, when you need it. Clear, affordable, and proven.
               </p>
           </div>
       </section>


       <!-- File Upload Section -->
       <div class="mb-8">
           <div class="file-upload-area p-8 rounded-2xl text-center cursor-pointer" id="fileUploadArea">
               <!-- Default upload state -->
               <div id="uploadDefault" class="upload-state">
                   <div class="mb-4">
                       <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48">
                           <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                       </svg>
                   </div>
                   <p class="text-lg font-medium text-gray-900 mb-2">Drop your resume here, or click to browse</p>
                   <p class="text-sm text-gray-500">Supports PDF, DOC, DOCX files up to 10MB</p>
               </div>
               
               <!-- File loaded state -->
               <div id="uploadLoaded" class="upload-state hidden">
                   <div class="mb-4">
                       <svg class="mx-auto h-12 w-12 text-green-500" stroke="currentColor" fill="none" viewBox="0 0 24 24">
                           <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                       </svg>
                   </div>
                   <p class="text-lg font-medium text-green-700 mb-2">File Loaded Successfully</p>
                   <p id="loadedFileName" class="text-sm text-gray-600 mb-2 font-mono bg-gray-100 px-3 py-1 rounded"></p>
                   <p class="text-xs text-gray-500">Click to change file</p>
               </div>
               
               <input type="file" id="fileInput" class="hidden" accept=".pdf,.doc,.docx" />
           </div>
       </div>

       <!-- Freemium Section -->
       <div class="grid grid-cols-1 mb-8">
            <div class="bg-gray-50 p-6 rounded-2xl border-2 border-dashed border-gray-200 flex flex-col items-center text-center">
               <h2 class="text-2xl font-bold text-gray-900 mb-2">Basic Resume Check</h2>
               <p class="text-sm text-gray-500 mb-4">Get a free, high-level analysis of your resume's formatting and readability.</p>
               <button id="free-button" class="w-full sm:w-auto py-3 px-8 rounded-xl font-bold text-white bg-gray-900 hover:bg-gray-700 transition-colors shadow-lg">
                   Try Now (Free)
               </button>
           </div>
       </div>

       <!-- Paid Pricing Grid -->
       <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">

           <!-- ATS Analysis Card -->
           <div class="bg-blue-50 bg-opacity-70 p-6 rounded-2xl border border-blue-100 flex flex-col justify-between">
               <div>
                   <div class="flex items-center text-blue-600 mb-2">
                       <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" viewBox="0 0 24 24" fill="currentColor">
                           <path d="M12 2C6.486 2 2 6.486 2 12s4.486 10 10 10 10-4.486 10-10S17.514 2 12 2zm-1 15h2v-6h-2v6zm0-8h2V7h-2v2z"/>
                       </svg>
                       <h2 class="text-xl font-bold">ATS Analysis</h2>
                   </div>
                   <p class="text-sm text-gray-700 mt-2">Get a detailed analysis of your resume's compatibility with a specific job description.</p>
               </div>
               <button class="buy-button mt-6 w-full py-3 px-4 rounded-xl font-bold text-white bg-blue-600 hover:bg-blue-700 transition-colors shadow-lg" data-product="resume_analysis" data-price="1.49">
                   Buy Now ($1.49)
               </button>
           </div>

           <!-- Cover Letter Card -->
           <div class="bg-green-50 bg-opacity-70 p-6 rounded-2xl border border-green-100 flex flex-col justify-between">
               <div>
                   <div class="flex items-center text-green-600 mb-2">
                       <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" viewBox="0 0 24 24" fill="currentColor">
                           <path d="M19 3H5a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2V5a2 2 0 00-2-2zM9 17H7v-2h2v2zm4 0h-2v-2h2v2zm4 0h-2v-2h2v2zm0-4h-2v-2h2v2zm0-4h-2V7h2v2z"/>
                       </svg>
                       <h2 class="text-xl font-bold">Cover Letter</h2>
                   </div>
                   <p class="text-sm text-gray-700 mt-2">Generate a personalized cover letter tailored to your resume and a target job.</p>
               </div>
               <button class="buy-button mt-6 w-full py-3 px-4 rounded-xl font-bold text-white bg-green-600 hover:bg-green-700 transition-colors shadow-lg" data-product="cover_letter" data-price="2.99">
                   Buy Now ($2.99)
               </button>
           </div>

           <!-- Job Fit Score Card -->
           <div class="bg-amber-50 bg-opacity-70 p-6 rounded-2xl border border-amber-100 flex flex-col justify-between">
               <div>
                   <div class="flex items-center text-amber-600 mb-2">
                       <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" viewBox="0 0 24 24" fill="currentColor">
                           <path d="M12 2a10 10 0 1010 10A10.011 10.011 0 0012 2zm0 18a8 8 0 118-8 8.009 8.009 0 01-8 8zm4-12.5a.5.5 0 10-1 0 .5.5 0 001 0zM11 15.5V17h2v-1.5z"/>
                       </svg>
                       <h2 class="text-xl font-bold">Job Fit Score</h2>
                   </div>
                   <p class="text-sm text-gray-700 mt-2">Get a quick score and detailed report on how well your resume fits a job.</p>
               </div>
               <button class="buy-button mt-6 w-full py-3 px-4 rounded-xl font-bold text-white bg-amber-600 hover:bg-amber-700 transition-colors shadow-lg" data-product="job_fit_analysis" data-price="1.99">
                   Buy Now ($1.99)
               </button>
        </div>
        
           <!-- Resume Rewrite Card - EPIC 1 COMPLETE -->
           <div class="bg-purple-50 bg-opacity-70 p-6 rounded-2xl border border-purple-100 flex flex-col justify-between">
               <div>
                   <div class="flex items-center text-purple-600 mb-2">
                       <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" viewBox="0 0 24 24" fill="currentColor">
                           <path d="M16 2H8a2 2 0 00-2 2v16a2 2 0 002 2h8a2 2 0 002-2V4a2 2 0 00-2-2zM9 10h6v2H9v-2zm0-4h6v2H9V6zm0 8h6v2H9v-2z"/>
                       </svg>
                       <h2 class="text-xl font-bold">Resume Rewrite</h2>
                   </div>
                   <p class="text-sm text-gray-700 mt-2">Complete job-targeted resume transformation. Upload your resume + job posting for a professional rewrite.</p>
               </div>
               <button class="buy-button mt-6 w-full py-3 px-4 rounded-xl font-bold text-white bg-purple-600 hover:bg-purple-700 transition-colors shadow-lg" data-product="resume_rewrite" data-price="4.99">
                   Buy Now ($4.99)
               </button>
           </div>

           <!-- Mock Interview Card -->
           <div class="bg-red-50 bg-opacity-70 p-6 rounded-2xl border border-red-100 flex flex-col justify-between">
               <div>
                   <div class="flex items-center text-red-600 mb-2">
                       <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" viewBox="0 0 24 24" fill="currentColor">
                           <path d="M12 2C6.486 2 2 6.486 2 12s4.486 10 10 10 10-4.486 10-10S17.514 2 12 2zm-1.5 15l-5-5 1.414-1.414L10.5 14.172l7.086-7.086L19 8.5l-8.5 8.5z"/>
                       </svg>
                       <h2 class="text-xl font-bold">Mock Interview</h2>
                   </div>
                   <p class="text-sm text-gray-700 mt-2">Complete interview simulation with strategic answers and company-specific preparation.</p>
               </div>
               <button class="buy-button mt-6 w-full py-3 px-4 rounded-xl font-bold text-white bg-red-600 hover:bg-red-700 transition-colors shadow-lg" data-product="mock_interview" data-price="3.99">
                   Buy Now ($3.99)
               </button>
           </div>

           <!-- The Power Pack Card - Coming Soon -->
           <div class="sm:col-span-2 bg-gray-50 bg-opacity-70 p-6 rounded-2xl border border-gray-200 flex flex-col justify-between opacity-60">
               <div>
                   <div class="flex items-center text-gray-500 mb-2">
                       <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" viewBox="0 0 24 24" fill="currentColor">
                           <path d="M12 22a10 10 0 1110-10A10.011 10.011 0 0112 22zM12 4a8 8 0 108 8 8.009 8.009 0 00-8-8zm0 13a5 5 0 115-5 5.006 5.006 0 01-5 5zm0-8a3 3 0 103 3 3.003 3.003 0 00-3-3z"/>
                       </svg>
                       <h2 class="text-xl font-bold">The Power Pack</h2>
                   </div>
                   <p class="text-sm text-gray-500 mt-2">Get the **Cover Letter Generator** and **Resume Rewrite** together for one low price. Best value!</p>
               </div>
               <button class="mt-6 w-full py-3 px-4 rounded-xl font-bold text-gray-400 bg-gray-300 cursor-not-allowed" disabled>
                   Coming Soon
               </button>
           </div>
                </div>
                
        </div>
                
        <!-- Results Modal -->
        <div id="resultsModal" class="results-modal">
            <div class="results-content relative">
                <button class="close-button" id="closeResultsModal">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
                <h3 class="text-2xl font-bold text-gray-900 mb-6">Analysis Results</h3>
                <div id="analysisResults" class="space-y-4"></div>
            </div>
        </div>
        
        <!-- Job Posting Modal -->
        <div id="jobPostingModal" class="results-modal">
            <div class="results-content relative max-w-2xl">
                <button class="close-button" id="closeJobPostingModal">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
                <h3 class="text-2xl font-bold text-gray-900 mb-6">Job Description</h3>
                <p class="text-gray-600 mb-4">Please paste the job description or posting you'd like us to tailor your cover letter to:</p>
                <textarea id="jobPostingTextarea" class="w-full h-64 p-4 border border-gray-300 rounded-lg resize-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="Paste the job description here..."></textarea>
                <div class="flex gap-3 mt-6">
                    <button id="submitJobPosting" class="flex-1 py-3 px-6 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700 transition-colors">
                        Continue
                    </button>
                    <button id="cancelJobPosting" class="flex-1 py-3 px-6 bg-gray-300 text-gray-700 rounded-lg font-semibold hover:bg-gray-400 transition-colors">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
        
   <!-- Loading overlay -->
   <div class="loading-overlay" id="loadingOverlay">
       <div class="text-center">
           <div class="hourglass"></div>
           <p class="text-white mt-4 text-lg">Processing your request...</p>
        </div>
    </div>

   </div>

   <!-- Footer -->
   <footer class="bg-white border-t border-gray-200 py-8 mt-auto">
       <div class="max-w-4xl mx-auto px-6 text-center text-gray-600">
           <h3 class="text-lg font-semibold text-gray-800 mb-2">Need Help?</h3>
           <p class="text-gray-600 mb-2">Our team is here to support your career success</p>
           <p class="mb-4">Contact us: <a href="mailto:support@idpetech.com" class="text-blue-600 hover:text-blue-800 font-medium">support@idpetech.com</a></p>
           <p class="text-sm text-gray-500">
               Trusted by professionals worldwide • Secure payment processing • 24/7 support
           </p>
       </div>
   </footer>

   <!-- Toast Notification System -->
   <div id="toast-container" class="fixed top-4 right-4 z-50 space-y-2"></div>


    <script>
       // Global variables
        let currentAnalysisId = null;
       let isProcessing = false;
       let premiumResultsDisplayed = false;


       document.addEventListener('DOMContentLoaded', () => {
           const fileUploadArea = document.getElementById('fileUploadArea');
           const fileInput = document.getElementById('fileInput');
           const freeButton = document.getElementById('free-button');
           const buyButtons = document.querySelectorAll('.buy-button');
           const resultsModal = document.getElementById('resultsModal');
           const analysisResults = document.getElementById('analysisResults');
           const loadingOverlay = document.getElementById('loadingOverlay');
           const closeResultsModal = document.getElementById('closeResultsModal');
           const jobPostingModal = document.getElementById('jobPostingModal');
           const jobPostingTextarea = document.getElementById('jobPostingTextarea');
           const submitJobPosting = document.getElementById('submitJobPosting');
           const cancelJobPosting = document.getElementById('cancelJobPosting');
           const closeJobPostingModal = document.getElementById('closeJobPostingModal');

           // Define all file handling functions in the same scope
           function handleFile(file) {
               if (!file) return;

               // Validate file type
               const allowedTypes = ['application/pdf', 'application/msword', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document'];
               if (!allowedTypes.includes(file.type)) {
                   window.showMessage ? window.showMessage('Please upload a PDF, DOC, or DOCX file.', 'error') : alert('Please upload a PDF, DOC, or DOCX file.');
                   return;
               }

               // Validate file size (10MB)
               if (file.size > 10 * 1024 * 1024) {
                   window.showMessage ? window.showMessage('File size must be less than 10MB.', 'error') : alert('File size must be less than 10MB.');
                   return;
               }

               // Store file for analysis
               window.currentFile = file;
               
               // Update UI to show file loaded state
               const uploadDefault = document.getElementById('uploadDefault');
               const uploadLoaded = document.getElementById('uploadLoaded');
               const loadedFileName = document.getElementById('loadedFileName');
               
               if (uploadDefault && uploadLoaded && loadedFileName) {
                   // Hide default state, show loaded state
                   uploadDefault.classList.add('hidden');
                   uploadLoaded.classList.remove('hidden');
                   
                   // Set filename
                   loadedFileName.textContent = file.name;
               }
               
               window.showMessage ? window.showMessage(`File "${file.name}" ready for analysis!`) : console.log(`File "${file.name}" ready for analysis!`);
           }

           const handleDragOver = function(e) {
               e.preventDefault();
               fileUploadArea.classList.add('dragover');
           };

           const handleDragLeave = function(e) {
               e.preventDefault();
               fileUploadArea.classList.remove('dragover');
           };

           const handleDrop = function(e) {
               e.preventDefault();
               fileUploadArea.classList.remove('dragover');
               const files = e.dataTransfer.files;
               if (files.length > 0) {
                   handleFile(files[0]);
               }
           };

           const handleFileSelect = function(e) {
               const file = e.target.files[0];
               if (file) {
                   handleFile(file);
               }
           };

           // File upload handling
           fileUploadArea.addEventListener('click', () => fileInput.click());
           fileUploadArea.addEventListener('dragover', handleDragOver);
           fileUploadArea.addEventListener('dragleave', handleDragLeave);
           fileUploadArea.addEventListener('drop', handleDrop);
           fileInput.addEventListener('change', handleFileSelect);
           
           // Reset file input when a new file is selected
           fileInput.addEventListener('change', () => {
               // Clear the input value to allow selecting the same file again
               if (fileInput.value) {
                   // File will be handled by handleFileSelect
               }
           });

           // Free analysis button
           freeButton.addEventListener('click', handleFreeAnalysis);

           // Buy buttons
           buyButtons.forEach(button => {
               button.addEventListener('click', (event) => {
                   const productType = event.target.dataset.product;
                   const price = event.target.dataset.price;
                   handlePremiumPurchase(productType, price);
               });
           });

           // Check for premium results on page load
           checkForPremiumResults();

           // Modal close functionality
           closeResultsModal.addEventListener('click', () => {
               resultsModal.classList.remove('show');
               clearCurrentFile(); // Clear file when user exits modal
           });

           // Close modal when clicking outside
           resultsModal.addEventListener('click', (e) => {
               if (e.target === resultsModal) {
                   resultsModal.classList.remove('show');
                   clearCurrentFile(); // Clear file when user exits modal
               }
           });

           // Close modal with Escape key
           document.addEventListener('keydown', (e) => {
               if (e.key === 'Escape') {
                   if (resultsModal.classList.contains('show')) {
                       resultsModal.classList.remove('show');
                       clearCurrentFile(); // Clear file when user exits modal
                   }
                   if (jobPostingModal.classList.contains('show')) {
                       jobPostingModal.classList.remove('show');
                   }
               }
           });

           // Job posting modal functionality
           closeJobPostingModal.addEventListener('click', () => {
               jobPostingModal.classList.remove('show');
           });

           jobPostingModal.addEventListener('click', (e) => {
               if (e.target === jobPostingModal) {
                   jobPostingModal.classList.remove('show');
               }
           });

           cancelJobPosting.addEventListener('click', () => {
               jobPostingModal.classList.remove('show');
               isProcessing = false;
               hideLoadingOverlay();
           });

           submitJobPosting.addEventListener('click', async () => {
               const jobPosting = jobPostingTextarea.value.trim();
               if (!jobPosting) {
                   showMessageFallback('Please enter a job description.', 'error');
                   return;
               }

               jobPostingModal.classList.remove('show');
               
               if (window.pendingPurchase) {
                   const { productType, price } = window.pendingPurchase;
                   window.pendingPurchase = null;
                   await processPremiumPurchase(productType, price, jobPosting);
               }
           });

           // Function moved to global scope below
       });
   </script>
   
   <script>
       // Helper function for showing messages within DOMContentLoaded scope
       function showMessageFallback(text, type = 'success') {
           // Use the global showMessage function from the second script tag
           if (typeof window.showMessage === 'function') {
               window.showMessage(text, type);
           } else {
               // Fallback to console if toast system not available
                   console.log(`[${type.toUpperCase()}] ${text}`);
               }
           }

           function showLoadingOverlay() {
               loadingOverlay.classList.add('show');
           }

           function hideLoadingOverlay() {
               loadingOverlay.classList.remove('show');
           }

           function clearCurrentFile() {
               console.log('Clearing current file for new upload');
               window.currentFile = null;
               resetFileUploadUI();
               
               // SECURITY: Clear session markers when starting fresh
               premiumResultsDisplayed = false;
               // Clear all premium session markers
               for (let i = sessionStorage.length - 1; i >= 0; i--) {
                   const key = sessionStorage.key(i);
                   if (key && key.startsWith('premium_displayed_')) {
                       sessionStorage.removeItem(key);
                   }
               }
           }

           // handleDragOver moved earlier to avoid ReferenceError

           // handleDragLeave moved earlier

           // handleDrop moved earlier

           function resetFileUploadUI() {
               const uploadDefault = document.getElementById('uploadDefault');
               const uploadLoaded = document.getElementById('uploadLoaded');
               
               if (uploadDefault && uploadLoaded) {
                   // Show default state, hide loaded state
                   uploadDefault.classList.remove('hidden');
                   uploadLoaded.classList.add('hidden');
               }
           }

           async function handleFreeAnalysis() {
               if (!window.currentFile) {
                   showMessage('Please upload a resume file first.', 'error');
                   return;
               }

               if (isProcessing) {
                   showMessage('Analysis already in progress...');
                return;
            }
            
               isProcessing = true;
               showLoadingOverlay();
            
            try {
                const formData = new FormData();
                   formData.append('file', window.currentFile);
                   formData.append('analysis_type', 'free');

                   const controller = new AbortController();
                   const timeoutId = setTimeout(() => controller.abort(), 60000);
                
                const response = await fetch('/api/v1/analyze', {
                    method: 'POST',
                       body: formData,
                       signal: controller.signal
                   });

                   clearTimeout(timeoutId);

                   if (!response.ok) {
                       throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                   }

                   const result = await response.json();
                   currentAnalysisId = result.analysis_id;
                   
                   displayResults(result);
                   showMessage('Free analysis completed!');

            } catch (error) {
                console.error('Analysis error:', error);
                   if (error.name === 'AbortError') {
                       showMessage('Analysis timed out. Please try again.', 'error');
                   } else {
                       showMessage('Analysis failed: ' + error.message, 'error');
                   }
            } finally {
                   isProcessing = false;
                   hideLoadingOverlay();
               }
           }




           function displayResults(result) {
               if (premiumResultsDisplayed) {
                   console.log('Premium results already displayed, not overwriting');
                   return;
               }

               console.log('📊 displayResults called with:', result);
               analysisResults.innerHTML = '';

               if (result.analysis_type === 'free' && result.result) {
                   try {
                       const analysis = result.result;
                       
                       // Overall Score
                       if (analysis.overall_score) {
                           const scoreHtml = `
                               <div class="bg-blue-50 p-4 rounded-lg">
                                   <h4 class="font-bold text-blue-900 mb-2">Overall Score</h4>
                                   <div class="text-3xl font-bold text-blue-600">${analysis.overall_score}/100</div>
                               </div>
                           `;
                           analysisResults.innerHTML += scoreHtml;
                       }

                       // Strengths
                       if (analysis.strength_highlights && analysis.strength_highlights.length > 0) {
                           const strengthsHtml = `
                               <div class="bg-green-50 p-4 rounded-lg">
                                   <h4 class="font-bold text-green-900 mb-2">Strengths</h4>
                                   <ul class="space-y-2">
                                       ${analysis.strength_highlights.map(strength => 
                                           `<li class="text-green-800">• ${strength}</li>`
                                       ).join('')}
                                   </ul>
                               </div>
                           `;
                           analysisResults.innerHTML += strengthsHtml;
                       }

                       // Improvements
                       if (analysis.improvement_opportunities && analysis.improvement_opportunities.length > 0) {
                           const improvementsHtml = `
                               <div class="bg-amber-50 p-4 rounded-lg">
                                   <h4 class="font-bold text-amber-900 mb-2">Improvement Opportunities</h4>
                                   <ul class="space-y-2">
                                       ${analysis.improvement_opportunities.map(improvement => 
                                           `<li class="text-amber-800">• ${improvement}</li>`
                                       ).join('')}
                                   </ul>
                               </div>
                           `;
                           analysisResults.innerHTML += improvementsHtml;
                       }

                       // Encouragement
                       if (analysis.encouragement_message) {
                           const encouragementHtml = `
                               <div class="bg-purple-50 p-4 rounded-lg">
                                   <h4 class="font-bold text-purple-900 mb-2">Encouragement</h4>
                                   <p class="text-purple-800">${analysis.encouragement_message}</p>
                               </div>
                           `;
                           analysisResults.innerHTML += encouragementHtml;
                       }

                       // Upselling to ATS Analysis
                       const upsellingHtml = `
                           <div class="bg-gradient-to-r from-blue-50 to-indigo-50 p-6 rounded-lg border-2 border-blue-200">
                               <div class="text-center">
                                   <h4 class="font-bold text-blue-900 mb-3 text-lg">🚀 Want to go deeper?</h4>
                                   <p class="text-blue-800 mb-4">Get a comprehensive ATS optimization analysis with specific improvements and text rewrites.</p>
                                   <button class="upsell-button bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition-colors shadow-lg" data-action="upsell">
                                       Get ATS Analysis - $1.49
                                   </button>
                               </div>
                           </div>
                       `;
                       analysisResults.innerHTML += upsellingHtml;

                       // Return to App button
                       const returnButtonHtml = `
                           <div class="text-center mt-6">
                               <button onclick="resultsModal.classList.remove('show'); clearCurrentFile();" class="bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg transition-colors">
                                   Return to App
                        </button>
                           </div>
                       `;
                       analysisResults.innerHTML += returnButtonHtml;

                   } catch (error) {
                       console.error('Error parsing analysis results:', error);
                       analysisResults.innerHTML = `
                           <div class="bg-red-50 p-4 rounded-lg">
                               <h4 class="font-bold text-red-900 mb-2">Analysis Results</h4>
                               <p class="text-red-800">Error displaying results. Please try again.</p>
                           </div>
                       `;
                   }
               } else {
                   console.log('Analysis result structure:', result);
                   analysisResults.innerHTML = `
                       <div class="bg-red-50 p-4 rounded-lg">
                           <h4 class="font-bold text-red-900 mb-2">Analysis Error</h4>
                           <p class="text-red-800">No results available. Check console for details.</p>
                           <p class="text-sm text-red-600 mt-2">Response structure: ${JSON.stringify(result, null, 2)}</p>
                    </div>
                `;
            }
            
               // Reset file upload UI to allow new file
               resetFileUploadUI();
               // Note: Keep window.currentFile for potential upselling - don't set to null
               
               // Show the modal
               console.log('🎯 About to show modal:', resultsModal);
               resultsModal.classList.add('show');
               console.log('✅ Modal show class added');
           }

           function checkForPremiumResults() {
               const urlParams = new URLSearchParams(window.location.search);
               const premium = urlParams.get('premium');
               const product = urlParams.get('product');
               const analysisId = urlParams.get('analysis_id');

               if (premium === 'true' && product && analysisId) {
                   // SECURITY: Clear URL parameters immediately to prevent re-access via refresh
                   window.history.replaceState({}, document.title, window.location.pathname);
                   
                   // Display results once
                   displayPremiumResults(analysisId, product);
               }
           }

           async function displayPremiumResults(analysisId, productType) {
               if (premiumResultsDisplayed) {
                   console.log('Premium results already displayed');
                return;
            }
            
               // SECURITY: Check if this analysis has already been displayed in this session
               const sessionKey = `premium_displayed_${analysisId}`;
               if (sessionStorage.getItem(sessionKey)) {
                   console.log('Premium results already displayed for this analysis in this session');
                   showMessage('Results already displayed in this session. Please complete a new payment for additional access.', 'warning');
                   return;
               }

               premiumResultsDisplayed = true;
               showLoadingOverlay();

               try {
                   const controller = new AbortController();
                   const timeoutId = setTimeout(() => controller.abort(), 45000);

                   const response = await fetch(`/api/v1/premium-results/${analysisId}?embedded=true&product_type=${productType}`, {
                       signal: controller.signal
                   });

                   clearTimeout(timeoutId);

                   if (!response.ok) {
                       throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                   }

                   const html = await response.text();
                   
                   analysisResults.innerHTML = html;
                   resultsModal.classList.add('show');
                   
                   // SECURITY: Mark this analysis as displayed in this session  
                   sessionStorage.setItem(sessionKey, 'true');
                   
                   // Premium results loaded - no toast needed, results speak for themselves
                   // Note: File will be cleared when user closes modal

            } catch (error) {
                   console.error('Premium results error:', error);
                   if (error.name === 'AbortError') {
                       showMessage('Premium results timed out. Please try again.', 'error');
                   } else {
                       showMessage('Failed to load premium results: ' + error.message, 'error');
                   }
               } finally {
                   hideLoadingOverlay();
               }
           }

           // Debug functions (available in console)
        window.testFunctions = {
               testPremiumResults: (analysisId, productType) => {
                   displayPremiumResults(analysisId, productType);
               },
               checkResultsDiv: () => {
                   console.log('Results modal:', resultsModal);
                   console.log('Analysis results:', analysisResults);
               },
               testRegion: (countryCode) => {
                   fetch(`/api/v1/pricing?region=${countryCode}`)
                       .then(r => r.json())
                       .then(console.log);
               },
               testStats: () => {
                   fetch('/api/v1/stats')
                       .then(r => r.json())
                       .then(console.log);
               }
           };

       });
   </script>

   <script>
       // Global helper functions
       function showMessage(text, type = 'success') {
           const toastContainer = document.getElementById('toast-container');
           if (!toastContainer) return;

           // Create toast element
           const toast = document.createElement('div');
           const toastId = 'toast-' + Date.now();
           toast.id = toastId;
           
           // Set colors based on type
           let bgColor, textColor, icon;
           switch (type) {
               case 'error':
                   bgColor = 'bg-red-500';
                   textColor = 'text-white';
                   icon = '❌';
                   break;
               case 'info':
                   bgColor = 'bg-blue-500';
                   textColor = 'text-white';
                   icon = 'ℹ️';
                   break;
               case 'warning':
                   bgColor = 'bg-yellow-500';
                   textColor = 'text-white';
                   icon = '⚠️';
                   break;
               default: // success
                   bgColor = 'bg-green-500';
                   textColor = 'text-white';
                   icon = '✅';
           }

           // Set toast content and styling
           toast.className = `${bgColor} ${textColor} px-6 py-4 rounded-lg shadow-lg transform transition-all duration-300 ease-in-out translate-x-full opacity-0`;
           toast.innerHTML = `
               <div class="flex items-center space-x-3">
                   <span class="text-lg">${icon}</span>
                   <span class="font-medium">${text}</span>
                   <button onclick="removeToast('${toastId}')" class="ml-4 text-white hover:text-gray-200 transition-colors">
                       <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                           <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                       </svg>
                   </button>
               </div>
           `;

           // Add to container
           toastContainer.appendChild(toast);

           // Animate in
           setTimeout(() => {
               toast.classList.remove('translate-x-full', 'opacity-0');
           }, 100);

           // Auto remove after 5 seconds
           setTimeout(() => {
               removeToast(toastId);
           }, 5000);
       }

       function removeToast(toastId) {
           const toast = document.getElementById(toastId);
           if (toast) {
               toast.classList.add('translate-x-full', 'opacity-0');
               setTimeout(() => {
                   if (toast.parentNode) {
                       toast.parentNode.removeChild(toast);
                   }
               }, 300);
           }
       }

       function showLoadingOverlay() {
           const loadingOverlay = document.getElementById('loadingOverlay');
           if (loadingOverlay) {
               loadingOverlay.classList.add('show');
           }
       }

       function hideLoadingOverlay() {
           const loadingOverlay = document.getElementById('loadingOverlay');
           if (loadingOverlay) {
               loadingOverlay.classList.remove('show');
           }
       }

       // Global function for upselling button
       async function handleUpsellPurchase() {
           console.log('Upsell button clicked!');
           
           // Get references to elements
           const resultsModal = document.getElementById('resultsModal');
           
           // Show message
           showMessage('Starting ATS analysis purchase...', 'info');
           
           // Close the results modal
           if (resultsModal) {
               resultsModal.style.display = 'none';
           }
           
           // Trigger premium purchase for ATS analysis
           const productType = 'resume_analysis';
           const price = 1.49;
           
           // Call the premium purchase function directly (ATS doesn't need job posting)
           await handlePremiumPurchase(productType, price);
       }

       // Global function for premium purchase
       async function handlePremiumPurchase(productType, price) {
           if (!window.currentFile) {
               showMessage('Please upload a resume file first.', 'error');
               return;
           }

           if (isProcessing) {
               showMessage('Operation already in progress...');
               return;
           }

           // Check if job posting is required
           if (productType === 'job_fit_analysis' || productType === 'cover_letter' || productType === 'resume_rewrite' || productType === 'mock_interview') {
               // Show job posting modal
               const jobPostingTextarea = document.getElementById('jobPostingTextarea');
               const jobPostingModal = document.getElementById('jobPostingModal');
               
               if (jobPostingTextarea && jobPostingModal) {
                   jobPostingTextarea.value = '';
                   jobPostingModal.classList.add('show');
                   
                   // Store the product info for when user submits
                   window.pendingPurchase = { productType, price };
                   return;
               }
           }

           // Proceed directly if no job posting required
           await processPremiumPurchase(productType, price);
       }

       // Global function for processing premium purchase
       async function processPremiumPurchase(productType, price, jobPosting = null) {
           isProcessing = true;
           showLoadingOverlay();

           try {
               // First, create an analysis if we don't have one
               let analysisId = currentAnalysisId;
               
               if (!analysisId) {
                   const formData = new FormData();
                   formData.append('file', window.currentFile);
                   formData.append('analysis_type', 'free');

                   const controller = new AbortController();
                   const timeoutId = setTimeout(() => controller.abort(), 60000);

                   const response = await fetch('/api/v1/analyze', {
                       method: 'POST',
                       body: formData,
                       signal: controller.signal
                   });

                   clearTimeout(timeoutId);

                   if (!response.ok) {
                       throw new Error(`Analysis failed: HTTP ${response.status}`);
                   }

                   const result = await response.json();
                   analysisId = result.analysis_id;
                   currentAnalysisId = analysisId;
               }

               // Now create payment session
               const paymentFormData = new FormData();
               paymentFormData.append('analysis_id', analysisId);
               paymentFormData.append('product_type', productType);
               paymentFormData.append('price', price);

               // Add job posting if provided
               if (jobPosting) {
                   paymentFormData.append('job_posting', jobPosting);
               }

               const controller = new AbortController();
               const timeoutId = setTimeout(() => controller.abort(), 30000);

               const response = await fetch('/api/v1/payment/create', {
                   method: 'POST',
                   body: paymentFormData,
                   signal: controller.signal
               });

               clearTimeout(timeoutId);

               if (!response.ok) {
                   throw new Error(`HTTP ${response.status}: ${response.statusText}`);
               }

               const result = await response.json();
               const paymentUrl = result.payment_url || result.payment_session?.payment_url;
               
               if (paymentUrl) {
                   // Redirect immediately - no toast needed
                   window.location.href = paymentUrl;
               } else {
                   console.log('Payment response:', result);
                   throw new Error('No payment URL received');
               }

           } catch (error) {
               console.error('Premium purchase error:', error);
               if (error.name === 'AbortError') {
                   showMessage('Request timed out. Please try again.', 'error');
               } else {
                   showMessage('Payment failed: ' + error.message, 'error');
               }
           } finally {
               isProcessing = false;
               hideLoadingOverlay();
           }
       }

       // Global function for upselling button

       // Upsell button handling is done via modal event delegation below

       // Also add event listener to results modal for better coverage
       document.addEventListener('DOMContentLoaded', function() {
           const resultsModal = document.getElementById('resultsModal');
           if (resultsModal) {
               resultsModal.addEventListener('click', function(e) {
                   console.log('Modal click detected on:', e.target);
                   const upsellButton = e.target.closest('.upsell-button');
                   if (upsellButton) {
                       console.log('Upsell button clicked via modal delegation!');
                       e.preventDefault();
                       handleUpsellPurchase();
                   }
               });
           }
       });

       // Export functions for PDF and DOCX downloads
       async function exportToPDF(analysisId) {
           try {
               showMessage('Generating PDF export...', 'info');
               
               const response = await fetch(`/api/v1/export/${analysisId}/pdf`);
               
               if (!response.ok) {
                   if (response.status === 402) {
                       showMessage('Payment required to export', 'error');
                       return;
                   } else if (response.status === 404) {
                       showMessage('Analysis not found', 'error');
                       return;
                   } else {
                       throw new Error(`HTTP ${response.status}`);
                   }
               }
               
               // Get the blob data
               const blob = await response.blob();
               
               // Create download link
               const url = window.URL.createObjectURL(blob);
               const a = document.createElement('a');
               a.href = url;
               a.download = getExportFilename(analysisId, 'pdf');
               document.body.appendChild(a);
               a.click();
               document.body.removeChild(a);
               window.URL.revokeObjectURL(url);
               
               showMessage('PDF export completed!', 'success');
               
           } catch (error) {
               console.error('PDF export error:', error);
               showMessage('Failed to export PDF: ' + error.message, 'error');
           }
       }

       async function exportToDOCX(analysisId) {
           try {
               showMessage('Generating DOCX export...', 'info');
               
               const response = await fetch(`/api/v1/export/${analysisId}/docx`);
               
               if (!response.ok) {
                   if (response.status === 400) {
                       showMessage('DOCX export not available for this analysis type', 'error');
                       return;
                   } else if (response.status === 402) {
                       showMessage('Payment required to export', 'error');
                       return;
                   } else if (response.status === 404) {
                       showMessage('Analysis not found', 'error');
                       return;
                   } else {
                       throw new Error(`HTTP ${response.status}`);
                   }
               }
               
               // Get the blob data
               const blob = await response.blob();
               
               // Create download link
               const url = window.URL.createObjectURL(blob);
               const a = document.createElement('a');
               a.href = url;
               a.download = getExportFilename(analysisId, 'docx');
               document.body.appendChild(a);
               a.click();
               document.body.removeChild(a);
               window.URL.revokeObjectURL(url);
               
               showMessage('DOCX export completed!', 'success');
               
           } catch (error) {
               console.error('DOCX export error:', error);
               showMessage('Failed to export DOCX: ' + error.message, 'error');
           }
       }

       function getExportFilename(analysisId, extension) {
           const timestamp = new Date().toISOString().split('T')[0];
           return `resume-analysis-${timestamp}.${extension}`;
       }

       // Client-side PDF generation function (using jsPDF + html2canvas)
       function exportToPDFClient(analysisId = null) {
           try {
               // Show loading message
               const pdfBtn = document.querySelector('.btn-danger, .pdf-btn, [onclick*="exportToPDFClient"]');
               if (pdfBtn) {
                   const originalText = pdfBtn.textContent;
                   pdfBtn.textContent = '⏳ Generating PDF...';
                   pdfBtn.disabled = true;
                   
                   setTimeout(() => {
                       pdfBtn.textContent = originalText;
                       pdfBtn.disabled = false;
                   }, 3000);
               }

               // Check if jsPDF is available
               if (typeof window.jspdf === 'undefined' || !window.jspdf.jsPDF) {
                   console.log('jsPDF not available, using fallback');
                   exportToPDFFallback();
                   return;
               }
               
               // Get the content to export and clean it
               const content = document.querySelector('.premium-results');
               if (!content) {
                   showMessage('No content found to export', 'error');
                   return;
               }
               
               // Store original states for interview questions if present
               let originalStates = [];
               const allDetails = document.querySelectorAll('[id^="details-"]');
               const allIcons = document.querySelectorAll('[id^="icon-"]');
               
               // If this is an interview template, expand all questions for export
               if (allDetails.length > 0) {
                   console.log('Interview template detected, expanding all questions for PDF export');
                   allDetails.forEach((detail, index) => {
                       originalStates[index] = detail.style.display;
                       detail.style.display = 'block';
                   });
                   allIcons.forEach(icon => {
                       icon.classList.add('expanded');
                   });
               }
               
               // If this is resume rewrite template, hide analysis section for cleaner export
               const analysisSection = document.querySelector('.analysis-section');
               let analysisOriginalDisplay = null;
               if (analysisSection) {
                   console.log('Resume rewrite template detected, hiding analysis section for PDF export');
                   analysisOriginalDisplay = analysisSection.style.display;
                   analysisSection.style.display = 'none';
               }
               
               // Temporarily hide action buttons for clean screenshot
               const actionElements = document.querySelectorAll('.actions, .btn, button, [onclick]');
               actionElements.forEach(element => {
                   element.style.display = 'none';
               });
               
               // Use html2canvas to capture the content
               html2canvas(content, {
                   scale: 2,
                   useCORS: true,
                   allowTaint: true,
                   backgroundColor: '#ffffff',
                   width: content.scrollWidth,
                   height: content.scrollHeight
               }).then(canvas => {
                   try {
                       const { jsPDF } = window.jspdf;
                       const pdf = new jsPDF('p', 'mm', 'a4');
                       
                       const imgData = canvas.toDataURL('image/png');
                       const imgWidth = 190; // A4 width in mm minus margins
                       const pageHeight = 290; // A4 height in mm minus margins
                       const imgHeight = (canvas.height * imgWidth) / canvas.width;
                       let heightLeft = imgHeight;
                       
                       let position = 10; // Start 10mm from top
                       
                       // Add first page
                       pdf.addImage(imgData, 'PNG', 10, position, imgWidth, imgHeight);
                       heightLeft -= pageHeight;
                       
                       // Add additional pages if needed
                       while (heightLeft >= 0) {
                           position = heightLeft - imgHeight + 10;
                           pdf.addPage();
                           pdf.addImage(imgData, 'PNG', 10, position, imgWidth, imgHeight);
                           heightLeft -= pageHeight;
                       }
                       
                       // Save the PDF with appropriate filename
                       const filename = `resume-analysis-${new Date().toISOString().split('T')[0]}.pdf`;
                       pdf.save(filename);
                       
                       showMessage('PDF downloaded successfully!', 'success');
                       
                   } catch (error) {
                       console.error('PDF generation error:', error);
                       showMessage('Error generating PDF. Please try again.', 'error');
                   } finally {
                       // Restore hidden action buttons
                       actionElements.forEach(element => {
                           element.style.display = '';
                       });
                       
                       // Restore original interview question states
                       if (allDetails.length > 0) {
                           allDetails.forEach((detail, index) => {
                               if (originalStates && originalStates[index] !== undefined) {
                                   detail.style.display = originalStates[index];
                               }
                           });
                           allIcons.forEach(icon => {
                               if (!originalStates || !originalStates.some(state => state === 'block')) {
                                   icon.classList.remove('expanded');
                               }
                           });
                       }
                       
                       // Restore analysis section if it was hidden
                       if (analysisSection && analysisOriginalDisplay !== null) {
                           analysisSection.style.display = analysisOriginalDisplay;
                       }
                   }
                   
               }).catch(error => {
                   console.error('html2canvas error:', error);
                   showMessage('Error capturing content. Please try again.', 'error');
                   // Restore hidden action buttons
                   const actionElements = document.querySelectorAll('.actions, .btn, button, [onclick]');
                   actionElements.forEach(element => {
                       element.style.display = '';
                   });
                   
                   // Restore original interview question states
                   if (allDetails.length > 0) {
                       allDetails.forEach((detail, index) => {
                           if (originalStates && originalStates[index] !== undefined) {
                               detail.style.display = originalStates[index];
                           }
                       });
                       allIcons.forEach(icon => {
                           if (!originalStates || !originalStates.some(state => state === 'block')) {
                               icon.classList.remove('expanded');
                           }
                       });
                   }
                   
                   // Restore analysis section if it was hidden
                   if (typeof analysisSection !== 'undefined' && analysisSection && analysisOriginalDisplay !== null) {
                       analysisSection.style.display = analysisOriginalDisplay;
                   }
               });
               
           } catch (error) {
               console.error('exportToPDFClient error:', error);
               showMessage('Error exporting PDF: ' + error.message, 'error');
           }
       }

       function exportToPDFFallback(analysisId = null) {
           // Fallback: use browser's print function
           showMessage('Using browser print dialog as fallback', 'info');
           window.print();
       }

       // Interview-specific functions for mock interview templates
       function toggleQuestion(questionNum) {
           const details = document.getElementById(`details-${questionNum}`);
           const icon = document.getElementById(`icon-${questionNum}`);
           
           if (!details || !icon) {
               console.error(`Question ${questionNum} elements not found`);
               return;
           }
           
           if (details.style.display === 'none' || details.style.display === '') {
               // Expand the question
               details.style.display = 'block';
               icon.classList.add('expanded');
               
               // Smooth scroll to question if needed
               setTimeout(() => {
                   const questionContainer = details.closest('.question-container');
                   if (questionContainer) {
                       const rect = questionContainer.getBoundingClientRect();
                       if (rect.top < 0) {
                           questionContainer.scrollIntoView({ 
                               behavior: 'smooth', 
                               block: 'start' 
                           });
                       }
                   }
               }, 100);
           } else {
               // Collapse the question
               details.style.display = 'none';
               icon.classList.remove('expanded');
           }
       }
       
       function toggleAllQuestions() {
           const expandAllBtn = document.getElementById('expandAllBtn');
           const expandAllText = document.getElementById('expandAllText');
           const allDetails = document.querySelectorAll('[id^="details-"]');
           const allIcons = document.querySelectorAll('[id^="icon-"]');
           
           if (!allDetails.length) {
               console.error('No interview questions found');
               return;
           }
           
           // Check if ALL questions are currently expanded (not just some)
           const allExpanded = Array.from(allDetails).every(detail => 
               detail.style.display === 'block'
           );
           
           if (allExpanded) {
               // Collapse all questions
               allDetails.forEach(detail => {
                   detail.style.display = 'none';
               });
               allIcons.forEach(icon => {
                   icon.classList.remove('expanded');
               });
               if (expandAllText) expandAllText.textContent = '📂 Expand All';
           } else {
               // Expand all questions
               allDetails.forEach(detail => {
                   detail.style.display = 'block';
               });
               allIcons.forEach(icon => {
                   icon.classList.add('expanded');
               });
               if (expandAllText) expandAllText.textContent = '📁 Collapse All';
           }
       }

       function exportToWord() {
           try {
               console.log('Starting DOCX export...');
               
               // Show loading message
               const docxBtn = document.querySelector('.docx-btn');
               if (docxBtn) {
                   const originalText = docxBtn.textContent;
                   docxBtn.textContent = '⏳ Generating DOCX...';
                   docxBtn.disabled = true;
                   
                   setTimeout(() => {
                       docxBtn.textContent = originalText;
                       docxBtn.disabled = false;
                   }, 5000);
               }
               
               // Get the content to export
               const content = document.querySelector('.premium-results');
               const title = 'Mock Interview Guide';
               
               if (!content) {
                   alert('❌ Content not found for DOCX export');
                   return;
               }
               
               // Clone the content and modify for export
               const clonedContent = content.cloneNode(true);
               
               // Show all question details in the clone (for interview exports)
               const allDetails = clonedContent.querySelectorAll('[id^="details-"]');
               allDetails.forEach(detail => {
                   detail.style.display = 'block';
                   detail.style.visibility = 'visible';
               });
               
               // Remove analysis section from clone (for resume rewrite exports)
               const clonedAnalysisSection = clonedContent.querySelector('.analysis-section');
               if (clonedAnalysisSection) {
                   console.log('Resume rewrite template detected, removing analysis section from DOCX export');
                   clonedAnalysisSection.remove();
               }
               
               // Also temporarily expand in original for proper cloning if needed
               const originalDetails = document.querySelectorAll('[id^="details-"]');
               let originalStates = [];
               if (originalDetails.length > 0) {
                   console.log('Interview template detected, ensuring all content is captured in DOCX export');
                   originalDetails.forEach((detail, index) => {
                       originalStates[index] = detail.style.display;
                       detail.style.display = 'block';
                   });
               }
               
               // Remove interactive elements
               const elementsToRemove = clonedContent.querySelectorAll('.expand-icon, .expand-all-btn, .actions, button, [onclick]');
               elementsToRemove.forEach(element => {
                   element.remove();
               });
               
               // Remove click handlers and clean up headers
               const questionHeaders = clonedContent.querySelectorAll('.question-header');
               questionHeaders.forEach(header => {
                   header.style.cursor = 'default';
                   header.removeAttribute('onclick');
                   header.style.backgroundColor = 'transparent';
               });
           
               // Create HTML content for Word
               const htmlContent = `
                   <!DOCTYPE html>
                   <html>
                   <head>
                       <meta charset="utf-8">
                       <title>${title}</title>
                       <style>
                           body { 
                               font-family: 'Times New Roman', serif; 
                               line-height: 1.6; 
                               margin: 40px;
                               color: #333;
                           }
                           .premium-header h2 {
                               color: #2c3e50;
                               text-align: center;
                               border-bottom: 2px solid #2c3e50;
                               padding-bottom: 10px;
                           }
                           .section h3 {
                               color: #2c3e50;
                               border-bottom: 1px solid #2c3e50;
                               padding-bottom: 5px;
                           }
                           .question-container {
                               margin-bottom: 25px;
                               border: 1px solid #ddd;
                               padding: 15px;
                               border-radius: 5px;
                           }
                           .question-category-badge {
                               background: #2c3e50;
                               color: white;
                               padding: 5px 10px;
                               border-radius: 3px;
                               font-size: 12px;
                               margin-bottom: 10px;
                               display: inline-block;
                           }
                           .strategic-approach, .sample-framework, .success-tips {
                               background: #f8f9fa;
                               padding: 10px;
                               margin: 10px 0;
                               border-left: 3px solid #007bff;
                           }
                           .key-points li {
                               margin: 5px 0;
                           }
                       </style>
                   </head>
                   <body>
                       ${clonedContent.outerHTML}
                   </body>
                   </html>
               `;
               
               // Create blob and download
               const blob = new Blob([htmlContent], {
                   type: 'application/msword'
               });
               
               const url = URL.createObjectURL(blob);
               const a = document.createElement('a');
               a.href = url;
               
               // Generate filename with timestamp
               const timestamp = new Date().toISOString().slice(0, 10);
               a.download = `Mock_Interview_Guide_${timestamp}.doc`;
               
               document.body.appendChild(a);
               a.click();
               document.body.removeChild(a);
               URL.revokeObjectURL(url);
               
               console.log('DOCX export completed successfully');
               
               // Restore original interview question states
               if (originalDetails.length > 0) {
                   originalDetails.forEach((detail, index) => {
                       if (originalStates && originalStates[index] !== undefined) {
                           detail.style.display = originalStates[index];
                       }
                   });
               }
               
           } catch (error) {
               console.error('DOCX export error:', error);
               alert('❌ Error generating DOCX file: ' + error.message);
               
               // Restore original interview question states on error
               if (typeof originalDetails !== 'undefined' && originalDetails.length > 0) {
                   originalDetails.forEach((detail, index) => {
                       if (originalStates && originalStates[index] !== undefined) {
                           detail.style.display = originalStates[index];
                       }
                   });
               }
           }
       }

       // Copy to clipboard function for all templates
       function copyToClipboard(elementSelector) {
           const element = document.querySelector(elementSelector);
           if (!element) {
               alert('❌ Content not found to copy.');
               return;
           }
           
           const content = element.textContent || element.innerText;
           navigator.clipboard.writeText(content).then(() => {
               alert('✅ Content copied to clipboard!');
           }).catch(err => {
               console.error('Failed to copy: ', err);
               // Fallback for older browsers
               const textArea = document.createElement('textarea');
               textArea.value = content;
               document.body.appendChild(textArea);
               textArea.select();
               try {
                   document.execCommand('copy');
                   alert('✅ Content copied to clipboard!');
               } catch (err) {
                   alert('❌ Failed to copy to clipboard. Please select and copy manually.');
               }
               document.body.removeChild(textArea);
           });
       }
   </script>

    <!-- Load external libraries for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
</body>
</html>